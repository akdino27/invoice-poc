<section class="invoice-detail-page">
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading invoice...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <p class="error-message">{{ error() }}</p>
      <a routerLink="/invoices" class="back-btn">← Back to Invoices</a>
    </div>
  } @else if (invoice(); as inv) {
    <div class="invoice-container">
      <!-- Header -->
      <div class="invoice-header">
        <div class="header-left">
          <a routerLink="/invoices" class="back-link">← Back to Invoices</a>
          <h1 class="invoice-title">
            Invoice {{ inv.invoiceNumber || 'N/A' }}
          </h1>
        </div>
        <div class="header-right">
          <!-- FIX: Check if date exists before formatting -->
          <span class="invoice-date">{{ inv.invoiceDate ? formatDate(inv.invoiceDate) : 'Date Not Specified' }}</span>
        </div>
      </div>

      <div class="invoice-content">
        <!-- Vendor & Billing Info -->
        <div class="info-grid">
          <div class="info-card">
            <h3>Vendor</h3>
            <p class="vendor-name">{{ inv.vendorName || 'Unknown Vendor' }}</p>
          </div>

          <div class="info-card">
            <h3>Bill To</h3>
            <p>{{ inv.billToName || 'Not Specified' }}</p>
          </div>

          @if (shipToAddress()) {
            <div class="info-card">
              <h3>Ship To</h3>
              <p>{{ shipToAddress() }}</p>
            </div>
          }

          @if (inv.orderId) {
            <div class="info-card">
              <h3>Order ID</h3>
              <p>{{ inv.orderId }}</p>
            </div>
          }
        </div>

        <!-- Line Items -->
        @if (inv.lineItems && inv.lineItems.length > 0) {
          <div class="line-items-section">
            <h2>Line Items</h2>
            <div class="table-container">
              <table class="line-items-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Product ID</th>
                    <th class="text-right">Quantity</th>
                    <th class="text-right">Unit Rate</th>
                    <th class="text-right">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of inv.lineItems; track item.id) {
                    <tr>
                      <td class="product-name">{{ item.productName }}</td>
                      <td>{{ item.category || '-' }}</td>
                      <td class="product-id">{{ item.productId }}</td>
                      <td class="text-right">{{ item.quantity }}</td>
                      <td class="text-right">{{ formatCurrency(item.unitRate) }}</td>
                      <td class="text-right">{{ formatCurrency(item.amount) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        } @else {
           <p class="text-muted">No line items found for this invoice.</p>
        }

        <!-- Totals -->
        <div class="totals-section">
          <div class="totals-row">
            <span class="total-label">Subtotal:</span>
            <span class="total-value">{{ formatCurrency(getSubtotal()) }}</span>
          </div>

          @if (hasDiscount()) {
            <div class="totals-row">
              <span class="total-label">
                Discount
                @if (getDiscountPercentage()) {
                  <span> ({{ getDiscountPercentage() }}%)</span>
                }:
              </span>
              <span class="total-value discount">-{{ formatCurrency(getDiscountAmount()) }}</span>
            </div>
          }

          @if (hasShipping()) {
            <div class="totals-row">
              <span class="total-label">Shipping:</span>
              <span class="total-value">{{ formatCurrency(getShippingCost()) }}</span>
            </div>
          }

          <div class="totals-row total">
            <span class="total-label">Total Amount:</span>
            <span class="total-value">{{ formatCurrency(getTotalAmount()) }}</span>
          </div>

          @if (hasBalanceDue()) {
            <div class="totals-row balance-due">
              <span class="total-label">Balance Due:</span>
              <span class="total-value">{{ formatCurrency(getBalanceDue()) }}</span>
            </div>
          }
        </div>

        <!-- Additional Info -->
        <div class="additional-info">
          @if (inv.notes) {
            <div class="info-section">
              <h3>Notes</h3>
              <p>{{ inv.notes }}</p>
            </div>
          }

          @if (inv.terms) {
            <div class="info-section">
              <h3>Terms</h3>
              <p>{{ inv.terms }}</p>
            </div>
          }

          @if (inv.shipMode) {
            <div class="info-section">
              <h3>Ship Mode</h3>
              <p>{{ inv.shipMode }}</p>
            </div>
          }
        </div>

        <!-- Metadata -->
        <div class="metadata">
          @if (inv.originalFileName) {
            <p><strong>Original File:</strong> {{ inv.originalFileName }}</p>
          }
          <!-- Use fallback string if dates missing -->
          <p><strong>Created:</strong> {{ inv.createdAt ? formatDate(inv.createdAt) : '-' }}</p>
          <p><strong>Last Updated:</strong> {{ inv.updatedAt ? formatDate(inv.updatedAt) : '-' }}</p>
        </div>
      </div>
    </div>
  }
</section>