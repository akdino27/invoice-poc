services:
  postgres:
    image: postgres:16
    container_name: app-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: secret
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  backend:
    build:
      context: ./backend
    container_name: invoice-backend
    depends_on:
      - postgres
    environment:
      ASPNETCORE_URLS: http://+:5247
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=appdb;Username=appuser;Password=secret
      # Updated to use the path defined in 'volumes' below
      GoogleDrive__ServiceAccountKeyPath: /secrets/service-account-key.json
      Worker__CallbackUrl: http://worker:8001
    volumes:
      - ./secrets/service-account-key.json:/secrets/service-account-key.json:ro
      - ./backend/Drive.Personal.Auth:/app/Drive.Personal.Auth
    ports:
      - "5247:5247"

  worker:
    build:
      context: ./worker
    container_name: invoice-worker
    depends_on:
      - postgres
      - backend
    env_file:
      - ./worker/.env
    environment:
      DB_HOST: postgres
      BACKEND_URL: http://backend:5247
      # Updated to use the path defined in 'volumes' below
      GOOGLE_SERVICE_ACCOUNT_KEY: /secrets/service-account-key.json
    volumes:
      - ./secrets/service-account-key.json:/secrets/service-account-key.json:ro
      - ./logs:/logs
    ports:
      - "8001:8001"

volumes:
  pgdata:
    external: true
    name: postgres_data